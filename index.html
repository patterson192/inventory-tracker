<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .facility-card {
            transition: all 0.3s ease-in-out;
        }
        .shipment-item {
            border-left-width: 4px;
        }
        .status-shipped {
            border-left-color: #f59e0b; /* amber-500 */
        }
        .status-received {
            border-left-color: #10b981; /* emerald-500 */
        }
        /* Spinner for loading state */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Login Container -->
    <div id="login-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold text-center text-slate-900 mb-2">Inventory Login</h2>
            <p class="text-center text-slate-500 mb-6">Please sign in to continue.</p>
            <form id="login-form" class="space-y-6">
            <div>
                    <label for="username" class="block text-sm font-medium text-slate-700">Username</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-600 focus:border-indigo-600" value="admin">
                    </div>
                    <div>
                    <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-600 focus:border-indigo-600" value="password">
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center hidden">Invalid username or password.</p>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-700 hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign In
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="p-4 lg:p-8 hidden">
        <div class="max-w-7xl mx-auto pb-24">
            <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                    <div></div>
                    <div>
                        <h1 class="text-4xl font-bold text-slate-900">Inter-Facility Inventory Tracker</h1>
                        <p class="text-lg text-slate-600 mt-2">Real-time shipment monitoring between facilities.</p>
                    </div>
                    <div>
                        <button id="logout-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
                            Logout
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main grid for facilities -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">

                <!-- Jack's Facility Card -->
                <div id="jack-facility" class="facility-card bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex items-center mb-4">
                        <div class="bg-teal-200 text-teal-900 rounded-full h-12 w-12 flex items-center justify-center text-xl font-bold">J</div>
                        <h2 class="text-2xl font-semibold ml-4">Jack's Facility</h2>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-lg mb-6">
                        <h3 class="font-semibold mb-3 text-slate-700">Create New Shipment</h3>
                        <form id="jack-ship-form" class="space-y-3">
                            <div>
                                <label for="jack-pieces" class="block text-sm font-medium text-slate-600">Number of Pieces</label>
                                <input type="number" id="jack-pieces" name="pieces" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-teal-600 focus:border-teal-600" placeholder="e.g., 100" required min="1">
                            </div>
                            <div>
                                <label for="jack-destination" class="block text-sm font-medium text-slate-600">Destination</label>
                                <select id="jack-destination" name="destination" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-teal-600 focus:border-teal-600">
                                    <option value="Kelly">Kelly's Facility</option>
                                    <option value="Rob">Rob's Facility</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-600 transition">
                                Ship Pieces
                            </button>
                </form>
                    </div>

                    <div class="flex-grow">
                        <h3 class="font-semibold mb-3 text-slate-700">Outgoing Shipments</h3>
                        <div id="jack-outgoing-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <p class="text-slate-500 text-sm">No outgoing shipments yet.</p>
            </div>
        </div>

                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <h4 class="font-semibold text-slate-800">Total Shipped / Received:</h4>
                        <p class="text-2xl font-bold text-teal-700">
                            <span id="jack-total-shipped">0</span> / <span id="jack-total-received" class="text-slate-400">0</span>
                        </p>
            </div>
        </div>

                <!-- Kelly's Facility Card -->
                <div id="kelly-facility" class="facility-card bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex items-center mb-4">
                        <div class="bg-orange-200 text-orange-900 rounded-full h-12 w-12 flex items-center justify-center text-xl font-bold">K</div>
                        <h2 class="text-2xl font-semibold ml-4">Kelly's Facility</h2>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-semibold mb-3 text-slate-700">Incoming from Jack</h3>
                        <div id="kelly-incoming-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                             <p class="text-slate-500 text-sm">No incoming shipments from Jack.</p>
            </div>
        </div>
        
                    <div class="bg-slate-50 p-4 rounded-lg mb-6">
                        <h3 class="font-semibold mb-3 text-slate-700">Ship to Rob</h3>
                        <form id="kelly-ship-form" class="space-y-3">
                            <div>
                               <label for="kelly-pieces" class="block text-sm font-medium text-slate-600">Number of Pieces</label>
                               <input type="number" id="kelly-pieces" name="pieces" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-600 focus:border-orange-600" placeholder="e.g., 50" required min="1">
                            </div>
                            <button type="submit" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-600 transition">
                               Ship to Rob
                            </button>
                        </form>
            </div>

                    <div class="flex-grow">
                        <h3 class="font-semibold mb-3 text-slate-700">Outgoing to Rob</h3>
                        <div id="kelly-outgoing-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                            <p class="text-slate-500 text-sm">No outgoing shipments to Rob.</p>
        </div>
    </div>

                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <h4 class="font-semibold text-slate-800">Total Shipped / Received:</h4>
                        <p class="text-2xl font-bold text-orange-700">
                            <span id="kelly-total-shipped">0</span> / <span id="kelly-total-received">0</span>
                        </p>
                    </div>
                </div>

                <!-- Rob's Facility Card -->
                <div id="rob-facility" class="facility-card bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex items-center mb-4">
                        <div class="bg-indigo-200 text-indigo-900 rounded-full h-12 w-12 flex items-center justify-center text-xl font-bold">R</div>
                        <h2 class="text-2xl font-semibold ml-4">Rob's Facility</h2>
                    </div>

                    <div class="flex-grow">
                        <h3 class="font-semibold mb-3 text-slate-700">Incoming Shipments</h3>
                        <div id="rob-incoming-list" class="space-y-3 max-h-[40rem] overflow-y-auto pr-2">
                            <p class="text-slate-500 text-sm">No incoming shipments.</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <h4 class="font-semibold text-slate-800">Total Received:</h4>
                        <p id="rob-total-received" class="text-2xl font-bold text-indigo-700">0</p>
                    </div>
                </div>

            </div>

            <!-- Search and Filter Section -->
            <div class="bg-white rounded-xl shadow-md p-4 mt-8">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="start-date" class="block text-sm font-medium text-slate-700">Start Date</label>
                        <input type="date" id="start-date" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-600 focus:border-indigo-600">
                    </div>
                    <div class="md:col-span-1">
                        <label for="end-date" class="block text-sm font-medium text-slate-700">End Date</label>
                        <input type="date" id="end-date" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-600 focus:border-indigo-600">
                    </div>
                    <div class="md:col-span-3 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="search-btn" class="w-full bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600 transition">
                            Search
                        </button>
                        <button id="reset-btn" class="w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition">
                            Reset
                        </button>
                        <button id="generate-summary-btn" class="w-full bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 transition flex items-center justify-center space-x-2">
                            <span>Summary</span>
                            <span class="text-lg">✨</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-slate-800">Shipment Summary ✨</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="summary-content" class="flex-grow overflow-y-auto pr-2">
                <div class="flex items-center justify-center h-full">
                    <div id="summary-loader" class="loader hidden"></div>
                    <p id="summary-text" class="text-slate-600 whitespace-pre-wrap"></p>
                    <p id="summary-error" class="text-red-600 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlFNjtfk68LHZJMyeYBqGRugh0juXV6AE",
            authDomain: "inventory-tracker-85848.firebaseapp.com",
            projectId: "inventory-tracker-85848",
            storageBucket: "inventory-tracker-85848.firebasestorage.app",
            messagingSenderId: "411980714677",
            appId: "1:411980714677:web:4ad98f863150fb3baba4fc",
            measurementId: "G-8SJD8L6YDZ"
        };
        const appId = 'inventory-tracker';

        let db, auth;
        let allShipments = []; 
        let currentlyDisplayedShipments = [];
        let dateFilter = { start: null, end: null };

        // --- DOM Element References ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const jackForm = document.getElementById('jack-ship-form');
        const kellyForm = document.getElementById('kelly-ship-form');
        const jackOutgoingList = document.getElementById('jack-outgoing-list');
        const kellyIncomingList = document.getElementById('kelly-incoming-list');
        const kellyOutgoingList = document.getElementById('kelly-outgoing-list');
        const robIncomingList = document.getElementById('rob-incoming-list');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const searchBtn = document.getElementById('search-btn');
        const resetBtn = document.getElementById('reset-btn');
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const summaryModal = document.getElementById('summary-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const summaryLoader = document.getElementById('summary-loader');
        const summaryText = document.getElementById('summary-text');
        const summaryError = document.getElementById('summary-error');

        // --- Login Logic ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            
            if (username === 'admin' && password === 'password') {
                sessionStorage.setItem('isLoggedIn', 'true'); // Persist login state
                loginError.classList.add('hidden');
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                initializeAppAndAuth();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // --- Logout Logic ---
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('isLoggedIn');
            loginContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            loginForm.reset();
            loginError.classList.add('hidden');
        });
        
        // --- Page Load Logic ---
        function checkLoginState() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initializeAppAndAuth();
            }
        }

        function initializeAppAndAuth() {
            // This check prevents re-initializing Firebase if the function is called multiple times.
            if (auth) return; 

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('Firebase user authenticated, initializing app logic.');
                        initializeAppLogic();
                    }
                });

                signInUser(); // Authenticate with Firebase backend
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.body.innerHTML = '<div class="text-center p-8 bg-red-100 text-red-800">Could not connect to the database. Please check the console for errors.</div>';
            }
        }
        
        // --- Core Functions ---
        function filterAndRender() {
            let shipmentsToRender = [...allShipments];

            if (dateFilter.start && dateFilter.end) {
                const endOfDay = new Date(dateFilter.end);
                endOfDay.setHours(23, 59, 59, 999);
                
                shipmentsToRender = shipmentsToRender.filter(shipment => {
                    if (!shipment.createdAt || !shipment.createdAt.toDate) return false;
                    const shipmentDate = shipment.createdAt.toDate();
                    return shipmentDate >= dateFilter.start && shipmentDate <= endOfDay;
                });
            }
            currentlyDisplayedShipments = shipmentsToRender;
            renderShipments(shipmentsToRender);
        }

        function renderShipments(shipments) {
            jackOutgoingList.innerHTML = '';
            kellyIncomingList.innerHTML = '';
            kellyOutgoingList.innerHTML = '';
            robIncomingList.innerHTML = '';

            const jackOut = shipments.filter(s => s.origin === 'Jack');
            const kellyIn = shipments.filter(s => s.destination === 'Kelly');
            const kellyOut = shipments.filter(s => s.origin === 'Kelly');
            const robIn = shipments.filter(s => s.destination === 'Rob');

            jackOut.length > 0 ? jackOut.forEach(s => jackOutgoingList.appendChild(createShipmentElement(s, 'jack'))) : jackOutgoingList.innerHTML = '<p class="text-slate-500 text-sm">No matching shipments.</p>';
            kellyIn.length > 0 ? kellyIn.forEach(s => kellyIncomingList.appendChild(createShipmentElement(s, 'kelly'))) : kellyIncomingList.innerHTML = '<p class="text-slate-500 text-sm">No matching shipments.</p>';
            kellyOut.length > 0 ? kellyOut.forEach(s => kellyOutgoingList.appendChild(createShipmentElement(s, 'kelly-out'))) : kellyOutgoingList.innerHTML = '<p class="text-slate-500 text-sm">No matching shipments.</p>';
            robIn.length > 0 ? robIn.forEach(s => robIncomingList.appendChild(createShipmentElement(s, 'rob'))) : robIncomingList.innerHTML = '<p class="text-slate-500 text-sm">No matching shipments.</p>';
            
            const jackTotalShipped = jackOut.reduce((sum, s) => sum + s.pieces, 0);
            const kellyTotalShipped = kellyOut.reduce((sum, s) => sum + s.pieces, 0);
            const kellyTotalReceived = kellyIn.filter(s => s.status === 'Received').reduce((sum, s) => sum + s.pieces, 0);
            const robTotalReceived = robIn.filter(s => s.status === 'Received').reduce((sum, s) => sum + s.pieces, 0);

            document.getElementById('jack-total-shipped').textContent = jackTotalShipped.toLocaleString();
            document.getElementById('jack-total-received').textContent = (0).toLocaleString();
            document.getElementById('kelly-total-shipped').textContent = kellyTotalShipped.toLocaleString();
            document.getElementById('kelly-total-received').textContent = kellyTotalReceived.toLocaleString();
            document.getElementById('rob-total-received').textContent = robTotalReceived.toLocaleString();
        }

        function createShipmentElement(shipment, perspective) {
            const div = document.createElement('div');
            const statusClass = shipment.status === 'Shipped' ? 'status-shipped' : 'status-received';
            div.className = `shipment-item bg-slate-50 rounded-lg p-3 shadow-sm ${statusClass}`;

            const statusIndicator = shipment.status === 'Received' 
                ? `<span class="text-xs font-bold text-green-700 bg-green-100 py-1 px-2 rounded-full">RECEIVED</span>`
                : `<span class="text-xs font-bold text-amber-700 bg-amber-100 py-1 px-2 rounded-full">SHIPPED</span>`;
            
            let dateString = 'Date not available';
            if (shipment.createdAt && shipment.createdAt.toDate) {
                const date = shipment.createdAt.toDate();
                dateString = date.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
            }

            let content = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-slate-800">${shipment.pieces} pieces</p>
                        <p class="text-sm text-slate-500">To: ${shipment.destination} from ${shipment.origin}</p>
                        <p class="text-xs text-slate-400 mt-1">${dateString}</p>
                    </div>
                    ${statusIndicator}
                </div>
            `;
            
            let controls = '<div class="mt-3 pt-3 border-t border-slate-200 flex items-center justify-between">';
            const isPaid = shipment.paid ? 'checked' : '';
            
            controls += `
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-id="${shipment.id}" class="paid-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${isPaid}>
                    <span class="text-sm font-medium text-slate-700">Paid</span>
                </label>
            `;

            if ((perspective === 'kelly' || perspective === 'rob') && shipment.status === 'Shipped') {
                controls += `
                    <button data-id="${shipment.id}" class="acknowledge-btn text-sm bg-green-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-600 transition">
                        Acknowledge
                    </button>`;
            }
            
            // Add delete button for all shipments
            controls += `
                <button data-id="${shipment.id}" class="delete-btn text-sm bg-red-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-red-600 transition">
                    Delete
                </button>`;
            controls += '</div>';

            content += controls;
            div.innerHTML = content;
            return div;
        }

        async function generateSummary(shipmentData) {
            summaryText.textContent = '';
            summaryError.classList.add('hidden');
            summaryLoader.classList.remove('hidden');

            const systemPrompt = "You are an expert inventory analyst. Your task is to create a clear, concise, and professional summary of shipment data for a logistics report. Focus on total pieces moved, movements between specific facilities, and the overall status of shipments (e.g., how many are shipped vs. received). Start with a high-level overview and then provide a bulleted list of key movements.";
            
            const simplifiedData = shipmentData.map(s => ({
                from: s.origin, to: s.destination, pieces: s.pieces,
                status: s.status, paid: s.paid
            }));

            const userQuery = `Please summarize the following shipment data:\n${JSON.stringify(simplifiedData, null, 2)}`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    summaryText.textContent = text;
                } else {
                    throw new Error("No content received from API.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                summaryError.textContent = `Failed to generate summary. Please try again. Error: ${error.message}`;
                summaryError.classList.remove('hidden');
            } finally {
                summaryLoader.classList.add('hidden');
            }
        }

        let appLogicInitialized = false;
        function initializeAppLogic() {
            if (appLogicInitialized) return;
            appLogicInitialized = true;

            const shipmentsCollection = collection(db, 'inventory');

            jackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pieces = parseInt(jackForm.pieces.value, 10);
                if (pieces > 0) {
                    await addDoc(shipmentsCollection, {
                        origin: 'Jack', destination: jackForm.destination.value, pieces,
                        status: 'Shipped', paid: false, createdAt: serverTimestamp()
                    });
                    jackForm.reset();
                }
            });
            
            kellyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pieces = parseInt(kellyForm.pieces.value, 10);
                if (pieces > 0) {
                    await addDoc(shipmentsCollection, {
                        origin: 'Kelly', destination: 'Rob', pieces,
                        status: 'Shipped', paid: false, createdAt: serverTimestamp()
                    });
                    kellyForm.reset();
                }
            });

            document.body.addEventListener('click', async (e) => {
                if (e.target.classList.contains('acknowledge-btn')) {
                    const shipmentId = e.target.dataset.id;
                    const shipmentRef = doc(db, 'inventory', shipmentId);
                    await updateDoc(shipmentRef, { status: 'Received' });
                } else if (e.target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this shipment? This action cannot be undone.')) {
                        const shipmentId = e.target.dataset.id;
                        const shipmentRef = doc(db, 'inventory', shipmentId);
                        await deleteDoc(shipmentRef);
                    }
                }
            });
            
            document.body.addEventListener('change', async (e) => {
                if (e.target.classList.contains('paid-checkbox')) {
                    const shipmentId = e.target.dataset.id;
                    const isPaid = e.target.checked;
                    const shipmentRef = doc(db, 'inventory', shipmentId);
                    await updateDoc(shipmentRef, { paid: isPaid });
                }
            });

            searchBtn.addEventListener('click', () => {
                if (startDateInput.value && endDateInput.value) {
                    dateFilter.start = new Date(startDateInput.value);
                    dateFilter.end = new Date(endDateInput.value);
                    filterAndRender();
                }
            });

            resetBtn.addEventListener('click', () => {
                startDateInput.value = '';
                endDateInput.value = '';
                dateFilter.start = null;
                dateFilter.end = null;
                filterAndRender();
            });

            generateSummaryBtn.addEventListener('click', () => {
                summaryModal.classList.remove('hidden');
                summaryModal.classList.add('flex');
                if (currentlyDisplayedShipments.length > 0) {
                    generateSummary(currentlyDisplayedShipments);
                } else {
                    summaryText.textContent = "No shipments to summarize. Please create or filter shipments to see a summary.";
                }
            });

            closeModalBtn.addEventListener('click', () => {
                summaryModal.classList.add('hidden');
                summaryModal.classList.remove('flex');
            });
            
            summaryModal.addEventListener('click', (e) => {
                if (e.target === summaryModal) {
                    summaryModal.classList.add('hidden');
                    summaryModal.classList.remove('flex');
                }
            });

            onSnapshot(query(collection(db, 'inventory')), (snapshot) => {
                allShipments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allShipments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                filterAndRender();
            });
        }

        async function signInUser() {
            try {
                if (auth.currentUser) return; // Already signed in
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }
        
        // --- Initialize the Page ---
        checkLoginState();
    </script>
</body>
</html>
